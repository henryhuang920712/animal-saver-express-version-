<!DOCTYPE html>
<html>
<head>
  <title>Animal Saver 動物救援知識小測驗</title>
  <link rel = "preconnect" href = "https://fonts.googleapis.com">
	<link rel = "preconnect" href = "https://fonts.gstatic.com" crossorigin>
	<link href = "https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@600&display=swap" rel = "stylesheet">
  <link href = "https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel = "stylesheet" 
  integrity = "sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin = "anonymous">
  <link href = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel = "stylesheet"
  integrity = "sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin = "anonymous">
  <link rel = "stylesheet" href = "https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" 
  integrity = "sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin = "anonymous">
  <script defer src = "https://use.fontawesome.com/releases/v5.0.13/js/solid.js"
  integrity = "sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin = "anonymous"></script>
  <script defer src = "https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js"
  integrity = "sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin = "anonymous"></script>
  <link rel = "stylesheet" type = "text/css" href = "/css/question.css">
</head>

<body class = "vh-100 pt-0">
  <button type = "button" class = "btn btn-info" id = "menu">
    <i class = "fas fa-align-left"></i>
    Menu
  </button>
  <nav id = "sidebar">
    <div class = "sidebar-header">
        <h3 style = "position: absolute; top: 50%; margin-top: -16.8px;">Menu</h3>
        <div id = "back">
            <i class = "fas fa-arrow-left"></i>
        </div>
    </div>
    <ul class = "list-unstyled components">
        <li>
            <a href = "/">Home</a>
        </li>
        <li>
            <a href = "instruction">救援指引</a>
        </li>
        <li>
            <a href = "form">線上通報表單</a>
        </li>
        <li>
            <a href = "preTest">動物救援知識小測驗</a>
        </li>
    </ul>
    <ul class = "list-unstyled CTAs">
        <li>
            <a href = "mailto:AnimalsaverNTU@gmail.com" id = "contact"> 聯絡我們</a>
        </li>
    </ul>
  </nav>

  <script src = "https://code.jquery.com/jquery-3.3.1.slim.min.js" 
  integrity = "sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin = "anonymous"></script>
  <script src = "https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" 
  integrity = "sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin = "anonymous"></script>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" 
  integrity = "sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin = "anonymous"></script>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
  <script type = "text/javascript">
    $(document).ready(function () {
        $("#sidebar").mCustomScrollbar({
            theme: "minimal"
        });
        $('#back, .overlay').on('click', function () {
            $('#sidebar').removeClass('active');
            $('.overlay').removeClass('active');
        });
        $('#menu').on('click', function () {
            $('#sidebar').addClass('active');
            $('.overlay').addClass('active');
            $('.collapse.in').toggleClass('in');
            $('a[aria-expanded=true]').attr('aria-expanded', 'false');
        });
    });
  </script>

  <div class = "progress" role = "progressbar" aria-label = "Basic example" aria-valuenow = "0" aria-valuemin = "0" aria-valuemax = "100">
    <div class = "progress-bar" aria-valuenow = "0">0%</div>
  </div>
  <div class = "container pt-5" id = "main">
    <div class = "row pt-5" id = "question">
      <div class = "card text-center quesTitle">
        <div class = "card-header" style = "font-size: 0.7cm;"></div>
        <div class = "card-body" style = "font-size: 1cm;">
          <p class = "card-text">With supporting text below as a natural lead-in to additional content.</p>
        </div>
      </div>
    </div>
    <div class = "card quesButton" id = "answer1">
      <div class = "card-body d-flex flex-column align-items-center">
        <div class = "card-title  ques-title">A</div>
        <p class = "card-text" style = "font-size: 0.75cm;"></p>
      </div>
    </div>
    <div class = "card quesButton" id = "answer2">
      <div class = "card-body d-flex flex-column align-items-center">
        <div class = "card-title ques-title">B</div>
        <p class = "card-text" style = "font-size: 0.75cm;"></p>
      </div>
    </div>
    <div class = "card quesButton" id = "answer3">
      <div class = "card-body d-flex flex-column align-items-center">
        <div class = "card-title ques-title">C</div>
        <p class = "card-text" style = "font-size: 0.75cm;"></p>
      </div>
    </div>
    <div class = "card quesButton" id = "answer4">
      <div class = "card-body d-flex flex-column align-items-center">
        <div class = "card-title ques-title">D</div>
        <p class = "card-text" style = "font-size: 0.75cm;"></p>
      </div>
    </div>
  </div>
  <script src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity = "sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin = "anonymous"></script>
</body>

<script>
  const quesNum = 10;  // 這個數字應該小於題庫的數量
  let counter = 1;
  let picked;
  const quesButtons = document.querySelectorAll('.quesButton');
  const quesTitle = document.querySelector('.quesTitle');
  const progressBar = document.querySelector(".progress-bar");
  const RenewContents = (pickedArr) => {

    let nowQues = pickedArr[counter - 1];
    let quesDes = quesTitle.querySelector('p');
    let quesNum = quesTitle.querySelector('.card-header');

    quesNum.textContent = `Question ${counter}`;
    quesDes.textContent = nowQues.name;
    quesButtons.forEach((item, i) => {
      let ref = ['a', 'b', 'c', 'd'];
      let quesText = item.querySelector('p');
      quesText.textContent = nowQues.options[ref[i]];
    })
  }

  const MoveProgress = () => {
    let targetValue = 100 * counter / quesNum;
    var duration = 200;
    var increment = targetValue / duration;
    var interval = 10;
    var timer = setInterval(function () {
      var currentValue = parseFloat(progressBar.getAttribute("aria-valuenow"));
      if (currentValue >= targetValue) {
        clearInterval(timer);
        progressBar.textContent = `${Math.round(targetValue * 100) / 100}%`;
      } else {
        currentValue += increment * interval;
        progressBar.setAttribute("aria-valuenow", currentValue);
        progressBar.style.width = currentValue + "%";
        progressBar.textContent = `${Math.round(currentValue * 100) / 100}%`;
      }
    }, interval);
  }

  async function fetchQuestions() {
    try {
      const res = await fetch("/posts");
      const data = await res.json();
      if (data.success) {
        const questions = data.data;
        const quesShuffled = questions.sort(() => 0.5 - Math.random());
        picked = quesShuffled.slice(0, quesNum);
      } else {
        console.error(data.error);
      }
    } catch (err) {
      console.error(err);
    }
  }
  window.addEventListener("popstate", () => {
    window.location.reload();
  });
  window.addEventListener("pageshow", function (event) {
    if (performance.navigation.type == 2) {
      location.reload(true);
    }
  });

  fetchQuestions()
    .then(() => {
      RenewContents(picked);
      MoveProgress();
      quesButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          picked[counter - 1]['user'] = btn.querySelector('.ques-title').textContent;
          if (counter === quesNum) {
            window.location.href = "/answers";
            localStorage.setItem('questions', JSON.stringify(picked));
          }
          btn.classList.toggle('fade-out-clicked');
          setTimeout(() => {
            RenewContents(picked);
            btn.classList.toggle('fade-out-clicked');
            MoveProgress();
          }, 250);
          counter++;
        })
      })
    })
    .catch((err) => {
      console.error(err);
    });
</script>
</html>